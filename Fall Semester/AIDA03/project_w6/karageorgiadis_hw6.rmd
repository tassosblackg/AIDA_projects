---
title: "HW6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R Problem Set 6 GIS

## Import libs

```{r libs}
library(sf)
library(raster)
library(rgdal)
library(tmap)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
```

## Read Data
```{r data}
med_heights_raster <- raster('data/30n000e_20101117_gmted_mea300.tif')
#   h2<-raster(system.file("data/30n000e_20101117_gmted_mea300.tif", package = "spDataLarge"))
#nomoi <- readOGR('data/GRC_ADM2/','GRC_ADM2')
nomoi <- st_read('data/GRC_ADM2/GRC_ADM2.shp')
poleis <- st_read('data/poleis/poleis.shp')
places <- st_read('data/places/places.shp')
```
# Show of the Data you Read
## Raster Map with Heights for Mediterranean
```{r Mediterranean heights}
plot(med_heights_raster)
```

## Greece Map with Regional Units
```{r greece map nomoi}
tm_shape(nomoi)+
 tm_polygons()
```


## Greece Dot map with places
```{r places map}
tm_shape(places)+
  tm_dots()
```


## Greece map with Big-Cities
```{r map with poleis}
tm_shape(poleis)+
  tm_dots()
```

-----------------------------------------------------

## Q1.| Greece Map with Heights <- |

-----------------------------------------------------
```{r greece map with heights}
gr_map<-(tm_shape(nomoi)+
 tm_polygons() +
  tm_shape(med_heights_raster)+
  tm_raster(alpha = 0.8))

gr_map
```

```{r heights with greece map }
tm_shape(med_heights_raster)+
  tm_raster(alpha = 0.7)+
  tm_shape(nomoi)+
 tm_polygons()
```
# Comment:
----------
As we see in the two code blocks I reversed the oder of layers, and got different results as matter of the resolution. In the first approach is more clear to see the heights levels in Greece terratory while the second one, is more generalized and showing in the map of heights in which region Greece is placed.


## Crop original raster to keep only Greece region
```{r greece raster}
greece_raster =crop(med_heights_raster,nomoi)
plot(greece_raster)
writeRaster(greece_raster,filename = 'gr_elevation.tif',overwrite=TRUE)
```
```{r greece raster2}
greece_raster_masked =mask(med_heights_raster,nomoi)
plot(greece_raster_masked)

```


--------------------------------------------------
## Q2.| Ypsometro Ana Poli / City Elevation Greece
--------------------------------------------------

```{r extract city height}
poleis$height <- raster::extract(greece_raster,poleis)

```
```{r}
# convert raster as data-frame
#heights_gr <- as.data.frame(greece_raster,xy=TRUE) %>% drop_na()
# rename third column
#heights_gr <-rename(heights_gr,elevation=X30n000e_20101117_gmted_mea300 )

#g1=ggplot()+geom_raster(aes(x=x,y=y,fill=elevation),data=heights_gr)+
 # geom_sf(fill='transparent',data=nomoi)+geom_sf(data=poleis)
#g1

tm_shape(nomoi)+
  tm_polygons() +
  tm_add_legend(title = 'elevation')+
  tm_shape(greece_raster)+
  tm_raster(alpha = 0.8)+
  tm_add_legend(title = 'City')+
  tm_shape(poleis)+
  tm_bubbles('height')  
```


--------------------------------------------------------------
## Q3.| Elevation for regional unit - Choropleth maps
--------------------------------------------------------------
```{r height for regional unit}
nomoi$mean_height <- raster::extract(x=greece_raster,y=nomoi,fun=mean,na.rm=TRUE)
nomoi$sd_height <- raster::extract(x=greece_raster,y=nomoi,fun=sd,na.rm=TRUE)

g1 = ggplot() + geom_sf(data = nomoi, aes(fill = sd_height))+scale_fill_gradient(low = "green", high = "black", na.value = NA)
g2 = ggplot() + geom_sf(data = nomoi, aes(fill = mean_height))+scale_fill_gradient(low = "yellow", high = "red", na.value = NA)

grid.arrange(g1, g2, nrow = 2)

#tm_shape(nomoi) + tm_fill(col = "mean_height", palette = "BuGn")
#tm_shape(nomoi) + tm_polygons(col = 'sd_height', palette = "BuGn")

```

-----------------------------------------------------------------
## Q4.|  Difference Between Region and City Height
-----------------------------------------------------------------
Pws tha sysxetistoun ta Regional Units me tis poleis kapoia prepei na ginoun merge


-----------------------------------------------------------------
## Q5.|  Top Ten 
-----------------------------------------------------------------
```{r Get Top Ten Regions}
nomoi_sorted_mean_height<-nomoi[order(nomoi$mean_height),]
nomoi_sorted_sd_height<-nomoi[order(nomoi$sd_height),]

tail(nomoi_sorted_mean_height$NAME,10)
tail(nomoi_sorted_sd_height$NAME,10)
```


---------------------------------------------------------
## Q6.| Ypsometro Ana topothesia /Place Elavation Greece
---------------------------------------------------------
```{r}
places$height <-raster::extract(greece_raster,places)

places_above1500 <- places %>% filter(places$height > 1500 )

#residential_places_above1500 <- places_above1500 %>% filter(places_above1500$population>0)


tm_shape(nomoi)+tm_polygons()+
  tm_shape(places_above1500)+tm_bubbles(col='population')+tm_text("name",auto.placement = TRUE)
  #tm_shape(residential_places_above1500)+tm_dots(col = 'red')+tm_text("name",auto.placement = TRUE)
```


---------------------------------------------------------
## Q7.| Reclassify Height 
---------------------------------------------------------
```{r}
m <- matrix(c(-4, 0, 0,
            1, 500, 500,
            500, 1000, 1000,
            1000, 1500, 1500,
            1500, 2000, 2000,
            2000, 2500, 2500,
            2500, 3000, 3000), ncol=3, byrow=TRUE)
greece_raster2 <- reclassify(greece_raster, m)

plot(greece_raster2)
```


---------------------------------------------------------
## Q8.| Line from one place to another
---------------------------------------------------------
```{r}
library(geosphere)
poli1 <- poleis %>% filter(poleis$NAME=='Beroia')
poli2 <- poleis %>% filter(poleis$NAME=='Kozani')

kozaniV_transect = cbind(c(347527.8, 4487220), c(311931.8, 4463305)) %>%
  st_linestring() %>% 
  st_sfc(crs = projection(greece_raster)) %>% 
  st_sf()

transect_kozani_veroia = raster::extract(greece_raster, kozaniV_transect, 
                           along = TRUE, cellnumbers = TRUE)
transect_df = as.data.frame(transect_kozani_veroia)

transect_coords = xyFromCell(greece_raster, transect_df$cell)
pair_dist = geosphere::distGeo(transect_coords)[-nrow(transect_coords)]
transect_df$dist = c(0, cumsum(pair_dist)) 

# 2d
poli3point <-c(411064.406052026, 4498811.99974354) # Thessaloniki
poli4point <-c(657687.375248732, 4523329.999301)  # Alexandroupoli

thessAlex_transect = cbind(poli3point, poli4point) %>%
  st_linestring() %>% 
  st_sfc(crs = projection(greece_raster)) %>% 
  st_sf()
transect_thess_alex = raster::extract(greece_raster, thessAlex_transect, 
                           along = TRUE, cellnumbers = TRUE)
transect_df2 = as.data.frame(transect_thess_alex)

transect_coords2 = xyFromCell(greece_raster, transect_df2$cell)
pair_dist2 = geosphere::distGeo(transect_coords2)[-nrow(transect_coords2)]
transect_df$dist = c(0, cumsum(pair_dist2)) 

# 3d
poli5point <-c(501576.59332262, 3930003.9991137) # Chania/Hania
poli6point <-c(360538.500761895, 4103975.00043856)  # Sparti

haniaSp_transect = cbind(poli5point, poli6point) %>%
  st_linestring() %>% 
  st_sfc(crs = projection(greece_raster)) %>% 
  st_sf()
transect_hania_spa = raster::extract(greece_raster, haniaSp_transect, 
                           along = TRUE, cellnumbers = TRUE)
transect_df3 = as.data.frame(transect_hania_spa)

transect_coords3 = xyFromCell(greece_raster, transect_df3$cell)
pair_dist3 = geosphere::distGeo(transect_coords3)[-nrow(transect_coords3)]
transect_df3$dist = c(0, cumsum(pair_dist3)) 


```

-----------------------------------------------------
## Q9.| Other Maps For Greece
-----------------------------------------------------
```{r}
# data taken from https://mapcruzin.com/free-greece-arcgis-maps-shapefiles.htm
rivers_gr<-st_read('data/greece-waterways-shape/waterways.shp')

tm_shape(nomoi)+tm_polygons()+
tm_shape(greece_raster)+tm_raster(alpha = 0.7,title = 'Heights',palette = c("white", "orange", "brown"))+
  tm_shape(rivers_gr)+tm_lines(col = 'width',palette=c('green','blue'))+
  tm_layout("Width of Rivers in GR",
            title.position =  c("right","bottom"),
          legend.title.size = 1,
          legend.text.size = 0.6,
          legend.position = c("left","bottom"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)
```
```{r}
# data taken from https://mapcruzin.com/free-greece-arcgis-maps-shapefiles.htm
rails <- st_read('data/greece-railways-shape/railways.shp')

tm_shape(nomoi)+tm_polygons(col = 'white')+
  #tm_shape(poleis)+tm_dots()+tm_text("NAME",auto.placement = TRUE)+
  tm_shape(rails)+tm_lines(col='type')+
    tm_layout("Condition of Railways",
            title.position =  c("right","top"),
          legend.title.size = 1,
          legend.text.size = 0.6,
          legend.position = c("left","bottom"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)
```
```{r}
# data taken from https://mapcruzin.com/free-greece-arcgis-maps-shapefiles.htm
natural <- st_read('data/greece-natural-shape/natural.shp')

# make invalid polygons to valid -fixes error
natural=st_make_valid(natural)

tm_shape(nomoi)+tm_polygons(col = 'white')+
  
  tm_shape(natural)+tm_polygons(col='type')+
    tm_layout("Natural SightSees",
            title.position =  c("right","top"),
          legend.title.size = 1,
          legend.text.size = 0.6,
          legend.position = c("left","bottom"),
          legend.bg.color = "white",
          legend.bg.alpha = 1)
    
```

